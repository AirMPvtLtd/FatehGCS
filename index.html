<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AiRM Fateh Drone Programming Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.min.js"></script>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f0ff;
            --secondary: #ff3e7f;
            --dark: #0a0a1a;
            --darker: #050510;
        }
        
        body {
            background: var(--dark);
            font-family: 'Ubuntu Mono', monospace;
            color: #e0e0ff;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .editor-font {
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
        }
        
        .interface-font {
            font-family: 'Ubuntu Mono', monospace;
        }
        
        .cyber-card {
            background: rgba(10, 10, 26, 0.9);
            border: 1px solid var(--primary);
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .cyber-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .cyber-button {
            background: rgba(0, 240, 255, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 6px 12px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cyber-button:hover {
            background: rgba(0, 240, 255, 0.2);
            box-shadow: 0 0 8px var(--primary);
        }
        
        .delete-button {
            background: rgba(255, 62, 127, 0.1);
            color: var(--secondary);
            border: 1px solid var(--secondary);
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .delete-button:hover {
            background: rgba(255, 62, 127, 0.2);
            box-shadow: 0 0 8px var(--secondary);
        }
        
        .add-button {
            background: rgba(0, 255, 128, 0.1);
            color: #00ff80;
            border: 1px solid #00ff80;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .add-button:hover {
            background: rgba(0, 255, 128, 0.2);
            box-shadow: 0 0 8px #00ff80;
        }
        
        .status-active {
            background: var(--primary);
            box-shadow: 0 0 8px var(--primary);
        }
        
        .hologram-container {
            width: 100%;
            height: 200px;
            position: relative;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .scrollable-container {
            overflow-y: auto;
            max-height: calc(100vh - 200px);
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--dark);
        }
        
        .scrollable-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-container::-webkit-scrollbar-track {
            background: var(--dark);
        }
        
        .scrollable-container::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 3px;
        }
        
        @media (max-height: 800px) {
            .scrollable-container {
                max-height: calc(100vh - 150px);
            }
        }
        
        .tab-active {
            background: rgba(0, 240, 255, 0.2);
            box-shadow: 0 0 8px var(--primary);
        }
        
        .completed-badge {
            background: rgba(0, 255, 128, 0.2);
            color: #00ff80;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .dynamic-height {
            height: calc(100vh - 180px);
            min-height: 500px;
        }

        .input-field {
            background: rgba(0, 0, 0, 0.8);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 4px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            box-shadow: 0 0 8px var(--primary);
        }

        .progress-bar {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--primary);
            border-radius: 4px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: var(--primary);
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
        }

        .telemetry-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.5);
        }

        .telemetry-table th, .telemetry-table td {
            border: 1px solid var(--primary);
            padding: 6px;
            text-align: center;
        }

        .telemetry-table th {
            background: rgba(0, 240, 255, 0.2);
        }

        .warning-message {
            background: rgba(255, 62, 127, 0.2);
            border: 1px solid var(--secondary);
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            color: var(--secondary);
            font-size: 12px;
        }

        .report-card {
            background: rgba(10, 10, 26, 0.9);
            border: 1px solid var(--primary);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            font-size: 12px;
        }

        .error-message {
            background: rgba(255, 62, 127, 0.2);
            border: 1px solid var(--secondary);
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            color: var(--secondary);
            font-size: 12px;
            text-align: center;
        }

        details summary {
            cursor: pointer;
            padding: 4px;
            background: rgba(0, 240, 255, 0.1);
            border: 1px solid var(--primary);
            border-radius: 4px;
            color: var(--primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
        }

        details summary:hover {
            background: rgba(0, 240, 255, 0.2);
        }

        details[open] summary {
            background: rgba(0, 240, 255, 0.2);
            box-shadow: 0 0 8px var(--primary);
        }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen"></div>

    <script type="text/babel" data-presets="react">
        function App() {
            const [status, setStatus] = React.useState('Initializing...');
            const [isSimulating, setIsSimulating] = React.useState(false);
            const [angles, setAngles] = React.useState([0, 0, 0]);
            const [height, setHeight] = React.useState(0);
            const [motorSpeeds, setMotorSpeeds] = React.useState([0, 0, 0, 0]);
            const [throttle, setThrottle] = React.useState(0);
            const [simulationError, setSimulationError] = React.useState(null);
            const [simulationWarnings, setSimulationWarnings] = React.useState([]);
            const [stabilityReport, setStabilityReport] = React.useState(null);
            const [activeTab, setActiveTab] = React.useState('FATEH-V1');
            const [editorContent, setEditorContent] = React.useState('');
            const [logicInput, setLogicInput] = React.useState('');
            const [buildOutput, setBuildOutput] = React.useState('');
            const [challenges, setChallenges] = React.useState([
                {
                    id: 1,
                    title: 'STABLE HOVER',
                    description: 'Maintain 1m altitude for 30 seconds',
                    points: 100,
                    criteria: { height: 1, rollMax: 5, pitchMax: 5, duration: 30 }
                },
                {
                    id: 2,
                    title: 'PRECISE ASCENT',
                    description: 'Reach 2m altitude in 10 seconds',
                    points: 150,
                    criteria: { height: 2, rollMax: 10, pitchMax: 10, duration: 10 }
                },
                {
                    id: 3,
                    title: 'SOFT LANDING',
                    description: 'Land from 1m altitude smoothly',
                    points: 200,
                    criteria: { height: 0, rollMax: 3, pitchMax: 3, duration: 15 }
                }
            ]);
            const [userProgress, setUserProgress] = React.useState({});
            const [leaderboard, setLeaderboard] = React.useState([]);
            const [profileData, setProfileData] = React.useState({
                name: '',
                collegeName: '',
                email: '',
                username: '',
                educationalBackground: ''
            });
            const [showProfileModal, setShowProfileModal] = React.useState(false);
            const [selectedProfiles, setSelectedProfiles] = React.useState([]);
            const [showDeleteConfirm, setShowDeleteConfirm] = React.useState(false);
            const [currentIp, setCurrentIp] = React.useState('');
            const [droneConfig, setDroneConfig] = React.useState({
                ip: '192.168.4.1',
                port: 8080,
                ssid: 'PicoW',
                password: 'pico1234'
            });
            const [isDeploying, setIsDeploying] = React.useState(false);
            const [connectionStatus, setConnectionStatus] = React.useState('Not connected');
            const [deployProgress, setDeployProgress] = React.useState(0);
            const [selectedTestScenario, setSelectedTestScenario] = React.useState('');
            const [testResult, setTestResult] = React.useState(null);
            const [customInputs, setCustomInputs] = React.useState({
                initialHeight: 0,
                initialRoll: 0,
                initialPitch: 0,
                initialYaw: 0
            });

            const containerRef = React.useRef(null);
            const engineRef = React.useRef(null);
            const sceneRef = React.useRef(null);
            const cameraRef = React.useRef(null);
            const droneGroupRef = React.useRef(null);
            const editorRef = React.useRef(null);

            // Test scenarios
            const testScenarios = [
                { id: 'hover', name: 'Hover at 1m', criteria: { height: 1, rollMax: 5, pitchMax: 5 } },
                { id: 'ascent', name: 'Ascent to 2m', criteria: { height: 2, rollMax: 10, pitchMax: 10 } },
                { id: 'yaw', name: 'Yaw 90°', criteria: { yaw: 90, rollMax: 5, pitchMax: 5 } }
            ];

            // Initialize IP and load data
            React.useEffect(() => {
                const generateRandomIp = () => {
                    return `${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}`;
                };
                setCurrentIp(generateRandomIp());
                const savedConfig = localStorage.getItem('droneConfig');
                if (savedConfig) {
                    setDroneConfig(JSON.parse(savedConfig));
                }
                const savedLeaderboard = localStorage.getItem('leaderboard');
                if (savedLeaderboard) {
                    setLeaderboard(JSON.parse(savedLeaderboard));
                }
            }, []);

            // Save leaderboard to localStorage
            React.useEffect(() => {
                localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
            }, [leaderboard]);

            const codeTemplates = {
                'FATEH-V1': `# FATEH V1 DEFAULT CONTROL SYSTEM
def mode(pids, throttle, angles, targets, dt):
    motor_speed = 65535 * (throttle / 100)
    return (motor_speed, motor_speed, motor_speed, motor_speed)`,
                
                'CUSTOM': `# CUSTOM DRONE CONTROL FUNCTION
def mode(pids, throttle, angles, targets, dt):
    kp = 1.0
    ki = 0.05
    kd = 0.2
    pids[0].set_gains(kp, ki, kd)
    pids[1].set_gains(kp, ki, kd)
    pids[2].set_gains(kp/2, ki, kd)
    base = max(throttle * 65535 * 0.5 / 100, 65535 * 0.25)
    roll_corr = pids[0].update(targets[0], angles[0], dt)
    pitch_corr = pids[1].update(targets[1], angles[1], dt)
    yaw_corr = pids[2].update(targets[2], angles[2], dt)
    return (
        base + pitch_corr + roll_corr + yaw_corr,
        base + pitch_corr - roll_corr - yaw_corr,
        base - pitch_corr + roll_corr - yaw_corr,
        base - pitch_corr - roll_corr + yaw_corr
    )`,
                
                'CHALLENGES': `# CHALLENGE MODE TEMPLATE
def mode(pids, throttle, angles, targets, dt):
    kp = 1.0
    ki = 0.05
    kd = 0.2
    pids[0].set_gains(kp, ki, kd)
    pids[1].set_gains(kp, ki, kd)
    pids[2].set_gains(kp/2, ki, kd)
    base = max(throttle * 65535 * 0.5 / 100, 65535 * 0.25)
    roll_corr = pids[0].update(0, angles[0], dt)
    pitch_corr = pids[1].update(0, angles[1], dt)
    yaw_corr = pids[2].update(0, angles[2], dt)
    return (
        base + pitch_corr + roll_corr + yaw_corr,
        base + pitch_corr - roll_corr - yaw_corr,
        base - pitch_corr + roll_corr - yaw_corr,
        base - pitch_corr - roll_corr + yaw_corr
    )`
            };

            React.useEffect(() => {
                const initializeEditor = async () => {
                    try {
                        window.require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' } });
                        window.require(['vs/editor/editor.main'], () => {
                            if (editorRef.current) editorRef.current.dispose();
                            
                            editorRef.current = monaco.editor.create(document.getElementById('editor'), {
                                value: codeTemplates[activeTab],
                                language: 'python',
                                theme: 'vs-dark',
                                fontFamily: 'Share Tech Mono',
                                fontSize: 14,
                                minimap: { enabled: false },
                                scrollBeyondLastLine: false,
                                automaticLayout: true
                            });
                            
                            editorRef.current.onDidChangeModelContent(() => {
                                setEditorContent(editorRef.current.getValue());
                            });
                            
                            setStatus('Ready');
                        });
                    } catch (error) {
                        console.error('Editor Initialization Error:', error);
                        setStatus('Editor initialization failed');
                    }
                };
                
                initializeEditor();
                
                return () => {
                    if (editorRef.current) {
                        editorRef.current.dispose();
                    }
                };
            }, [activeTab]);

            // Simulate code execution
            const simulateCode = () => {
                try {
                    if (!editorContent.includes('def mode(')) {
                        throw new Error('Missing mode() function');
                    }

                    // Mock PID controller
                    class PID {
                        constructor() {
                            this.kp = 1.0;
                            this.ki = 0.05;
                            this.kd = 0.2;
                            this.integral = 0;
                            this.prevError = 0;
                        }
                        set_gains(kp, ki, kd) {
                            this.kp = kp;
                            this.ki = ki;
                            this.kd = kd;
                        }
                        update(target, current, dt) {
                            const error = target - current;
                            this.integral += error * dt;
                            const derivative = (error - this.prevError) / dt;
                            this.prevError = error;
                            return this.kp * error + this.ki * this.integral + this.kd * derivative;
                        }
                    }

                    const pids = [new PID(), new PID(), new PID()];
                    let simThrottle = throttle;
                    let simAngles = [...angles];
                    let simHeight = height;
                    let simMotorSpeeds = [0, 0, 0, 0];
                    const dt = 0.016; // 60 FPS

                    // Simplified code evaluation
                    const code = `
                        ${editorContent}
                        return mode(pids, ${simThrottle}, [${simAngles}], [0, 0, 0], ${dt})
                    `;
                    const result = eval(code.replace('def mode', 'function mode')); // Unsafe but for simulation only
                    simMotorSpeeds = result.map(speed => Math.max(0, Math.min(65535, speed)));

                    // Update drone state
                    const avgSpeed = simMotorSpeeds.reduce((a, b) => a + b, 0) / 4;
                    simHeight += (avgSpeed / 65535) * 0.1 * dt * 100; // Scale to meters
                    simHeight = Math.max(0, Math.min(10, simHeight)); // Limit height

                    // Simplified angle updates based on motor differences
                    const rollDiff = (simMotorSpeeds[1] + simMotorSpeeds[2] - simMotorSpeeds[0] - simMotorSpeeds[3]) / 65535;
                    const pitchDiff = (simMotorSpeeds[0] + simMotorSpeeds[1] - simMotorSpeeds[2] - simMotorSpeeds[3]) / 65535;
                    simAngles[0] += rollDiff * 5; // Roll
                    simAngles[1] += pitchDiff * 5; // Pitch
                    simAngles[0] = Math.max(-45, Math.min(45, simAngles[0]));
                    simAngles[1] = Math.max(-45, Math.min(45, simAngles[1]));

                    // Check for warnings
                    const newWarnings = [];
                    if (simHeight <= 0 && simThrottle > 0) {
                        newWarnings.push('Crash Detected: Height reached 0m');
                    }
                    if (Math.abs(simAngles[0]) > 45 || Math.abs(simAngles[1]) > 45) {
                        newWarnings.push('Excessive Roll/Pitch Detected');
                    }
                    if (simMotorSpeeds.some(speed => speed >= 65535)) {
                        newWarnings.push('Motor Speed Limit Exceeded');
                    }
                    setSimulationWarnings(newWarnings);

                    // Update state
                    setHeight(simHeight);
                    setAngles(simAngles);
                    setMotorSpeeds(simMotorSpeeds);
                    setThrottle(simThrottle);

                    // Check test scenario
                    if (selectedTestScenario) {
                        const scenario = testScenarios.find(s => s.id === selectedTestScenario);
                        if (scenario) {
                            const heightOk = Math.abs(simHeight - scenario.criteria.height) <= 0.5;
                            const rollOk = Math.abs(simAngles[0]) <= scenario.criteria.rollMax;
                            const pitchOk = Math.abs(simAngles[1]) <= scenario.criteria.pitchMax;
                            const yawOk = !scenario.criteria.yaw || Math.abs(simAngles[2] - scenario.criteria.yaw) <= 5;
                            setTestResult({
                                scenario: scenario.name,
                                passed: heightOk && rollOk && pitchOk && yawOk,
                                details: {
                                    height: heightOk ? 'Pass' : `Fail (Expected ${scenario.criteria.height}m, Got ${simHeight.toFixed(1)}m)`,
                                    roll: rollOk ? 'Pass' : `Fail (Expected <${scenario.criteria.rollMax}°, Got ${simAngles[0].toFixed(1)}°)`,
                                    pitch: pitchOk ? 'Pass' : `Fail (Expected <${scenario.criteria.pitchMax}°, Got ${simAngles[1].toFixed(1)}°)`,
                                    yaw: yawOk ? 'Pass' : `Fail (Expected ${scenario.criteria.yaw}°, Got ${simAngles[2].toFixed(1)}°)`
                                }
                            });
                        }
                    }

                    // Calculate stability metrics
                    const stabilityScore = 100 - (Math.abs(simAngles[0]) + Math.abs(simAngles[1])) / 0.9; // Max 45° each
                    const responseTime = simHeight > 0 ? 1 / (Math.abs(simHeight - customInputs.initialHeight) / dt) : 0;
                    setStabilityReport({
                        stabilityScore: Math.max(0, Math.min(100, stabilityScore.toFixed(1))),
                        responseTime: responseTime.toFixed(2)
                    });

                } catch (error) {
                    setSimulationError('Code Execution Error: ' + error.message);
                    setIsSimulating(false);
                }
            };

            // Babylon.js Simulation Setup
            React.useEffect(() => {
                let mounted = true;
                let retryCount = 0;
                const maxRetries = 5;
                const retryInterval = 200; // ms

                const initializeSimulation = () => {
                    if (!mounted) return;

                    console.log(`Attempting to initialize Babylon.js simulation (Attempt ${retryCount + 1}/${maxRetries})...`);
                    console.log('Container ref:', containerRef.current);
                    console.log('Container in DOM:', document.getElementById('simulation-container'));

                    if (!containerRef.current) {
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.warn(`Container not found, retrying in ${retryInterval}ms...`);
                            setTimeout(initializeSimulation, retryInterval);
                            return;
                        } else {
                            console.error('Simulation Error: containerRef is null after max retries');
                            setSimulationError('Container element not found after multiple attempts. Please refresh the page.');
                            return;
                        }
                    }

                    if (!window.BABYLON) {
                        console.error('Babylon.js library not loaded');
                        setSimulationError('Babylon.js library failed to load. Please check your network connection.');
                        return;
                    }

                    try {
                        const canvas = document.createElement('canvas');
                        canvas.style.width = '100%';
                        canvas.style.height = '200px';
                        containerRef.current.appendChild(canvas);

                        const engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
                        engineRef.current = engine;
                        console.log('Babylon.js engine initialized');

                        const scene = new BABYLON.Scene(engine);
                        scene.clearColor = new BABYLON.Color4(0, 0, 0, 0);
                        sceneRef.current = scene;
                        console.log('Scene initialized');

                        const camera = new BABYLON.ArcRotateCamera(
                            'camera',
                            -Math.PI / 2,
                            Math.PI / 4,
                            5,
                            new BABYLON.Vector3(0, 0, 0),
                            scene
                        );
                        camera.attachControl(canvas, true);
                        cameraRef.current = camera;
                        console.log('Camera initialized');

                        const droneGroup = new BABYLON.Mesh('droneGroup', scene);

                        const body = BABYLON.MeshBuilder.CreateBox('body', { width: 0.5, height: 0.2, depth: 0.5 }, scene);
                        const bodyMaterial = new BABYLON.StandardMaterial('bodyMat', scene);
                        bodyMaterial.diffuseColor = new BABYLON.Color3.FromHexString('#00f0ff');
                        bodyMaterial.wireframe = true;
                        body.material = bodyMaterial;
                        body.parent = droneGroup;
                        console.log('Drone body added');

                        for (let i = 0; i < 4; i++) {
                            const arm = BABYLON.MeshBuilder.CreateBox('arm' + i, { width: 0.8, height: 0.05, depth: 0.05 }, scene);
                            const armMaterial = new BABYLON.StandardMaterial('armMat' + i, scene);
                            armMaterial.diffuseColor = new BABYLON.Color3.FromHexString('#ff3e7f');
                            armMaterial.wireframe = true;
                            arm.material = armMaterial;
                            arm.position = new BABYLON.Vector3(
                                0.5 * Math.cos((i * Math.PI) / 2),
                                0,
                                0.5 * Math.sin((i * Math.PI) / 2)
                            );
                            arm.rotation.y = (i * Math.PI) / 2;
                            arm.parent = droneGroup;
                        }
                        console.log('Drone arms added');

                        for (let i = 0; i < 4; i++) {
                            const prop = BABYLON.MeshBuilder.CreateCylinder('prop' + i, { diameter: 0.4, height: 0.02, tessellation: 16 }, scene);
                            const propMaterial = new BABYLON.StandardMaterial('propMat' + i, scene);
                            propMaterial.diffuseColor = new BABYLON.Color3.FromHexString('#00ff88');
                            propMaterial.wireframe = true;
                            prop.material = propMaterial;
                            prop.position = new BABYLON.Vector3(
                                0.7 * Math.cos((i * Math.PI) / 2),
                                0.1,
                                0.7 * Math.sin((i * Math.PI) / 2)
                            );
                            prop.parent = droneGroup;
                        }
                        console.log('Drone propellers added');

                        droneGroupRef.current = droneGroup;
                        console.log('Drone group initialized');

                        const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
                        light.intensity = 0.7;
                        console.log('Light added');

                        const animate = () => {
                            if (!mounted) return;

                            try {
                                if (!droneGroupRef.current || !sceneRef.current || !engineRef.current) {
                                    console.error('Animation Error: Missing refs', {
                                        droneGroup: !!droneGroupRef.current,
                                        scene: !!sceneRef.current,
                                        engine: !!engineRef.current
                                    });
                                    setSimulationError('Animation failed: Missing components');
                                    return;
                                }

                                if (isSimulating) {
                                    droneGroupRef.current.rotation.x = angles[1] * (Math.PI / 180);
                                    droneGroupRef.current.rotation.z = -angles[0] * (Math.PI / 180);
                                    droneGroupRef.current.rotation.y = angles[2] * (Math.PI / 180);
                                    droneGroupRef.current.position.y = height * 0.1;

                                    droneGroupRef.current.getChildMeshes().forEach((mesh, index) => {
                                        if (mesh.name.startsWith('prop')) {
                                            mesh.rotation.z += 0.1 * (motorSpeeds[index - 4] / 65535);
                                        }
                                    });

                                    simulateCode();
                                }

                                engineRef.current.runRenderLoop(() => {
                                    sceneRef.current.render();
                                });
                            } catch (error) {
                                console.error('Animation Error:', error);
                                setSimulationError('Animation rendering failed: ' + error.message);
                                engineRef.current.stopRenderLoop();
                            }
                        };

                        console.log('Starting animation loop');
                        animate();
                        setSimulationError(null);

                        const handleResize = () => {
                            try {
                                if (containerRef.current && engineRef.current) {
                                    engineRef.current.resize();
                                    console.log('Engine resized');
                                }
                            } catch (error) {
                                console.error('Resize Error:', error);
                                setSimulationError('Window resize handling failed: ' + error.message);
                            }
                        };

                        window.addEventListener('resize', handleResize);

                        return () => {
                            mounted = false;
                            try {
                                console.log('Cleaning up Babylon.js simulation');
                                window.removeEventListener('resize', handleResize);
                                if (engineRef.current) {
                                    engineRef.current.stopRenderLoop();
                                    engineRef.current.dispose();
                                }
                                if (containerRef.current && canvas) {
                                    containerRef.current.removeChild(canvas);
                                }
                            } catch (error) {
                                console.error('Cleanup Error:', error);
                                setSimulationError('Simulation cleanup failed: ' + error.message);
                            }
                        };
                    } catch (error) {
                        console.error('Babylon.js Initialization Error:', error);
                        setSimulationError('Failed to initialize 3D simulation: ' + error.message);
                    }
                };

                const timeoutId = setTimeout(initializeSimulation, 100);

                return () => {
                    clearTimeout(timeoutId);
                    mounted = false;
                };
            }, [isSimulating, angles, height, motorSpeeds, throttle]);

            // Test drone connection
            const testDroneConnection = async () => {
                setConnectionStatus('Testing connection...');
                try {
                    const response = await fetch(`http://${droneConfig.ip}:${droneConfig.port}/ping`, {
                        method: 'GET',
                        timeout: 2000
                    });
                    if (response.ok) {
                        setConnectionStatus('Connected');
                        setStatus('Drone connection successful');
                    } else {
                        setConnectionStatus('Connection failed');
                        setStatus('Failed to connect to drone');
                    }
                } catch (error) {
                    console.error('Connection Test Error:', error);
                    setConnectionStatus('Connection failed');
                    setStatus(`Failed to connect to drone: ${error.message}`);
                }
            };

            // Save drone config to localStorage
            const saveDroneConfig = (newConfig) => {
                setDroneConfig(newConfig);
                localStorage.setItem('droneConfig', JSON.stringify(newConfig));
            };

            // Validate email format
            const validateEmail = (email) => {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            };

            // Save profile to CSV
            const saveToCsv = (profile) => {
                const csvHeader = "Name,College Name,Email ID,Username,Educational Background,Score,IP\n";
                const escapeCsvField = (field) => `"${field.replace(/"/g, '""')}"`;
                const csvRow = [
                    escapeCsvField(profile.name),
                    escapeCsvField(profile.collegeName),
                    escapeCsvField(profile.email),
                    escapeCsvField(profile.username),
                    escapeCsvField(profile.educationalBackground),
                    profile.score,
                    escapeCsvField(profile.ip)
                ].join(',');
                const existingCsv = localStorage.getItem('profileDatabase') || csvHeader;
                const updatedCsv = existingCsv + csvRow + '\n';
                localStorage.setItem('profileDatabase', updatedCsv);
            };

            const handleCreateProfile = () => {
                const { name, collegeName, email, username, educationalBackground } = profileData;
                if (!name.trim() || !collegeName.trim() || !email.trim() || !username.trim() || !educationalBackground.trim()) {
                    setStatus('All fields are required');
                    return;
                }
                if (username.length > 15) {
                    setStatus('Username must be 15 characters or less');
                    return;
                }
                if (!validateEmail(email)) {
                    setStatus('Invalid email format');
                    return;
                }
                if (name.length > 100 || collegeName.length > 100 || educationalBackground.length > 100) {
                    setStatus('Fields must be 100 characters or less');
                    return;
                }
                if (leaderboard.some(entry => entry.username === username)) {
                    setStatus('Username already exists');
                    return;
                }
                
                const newProfile = {
                    name,
                    collegeName,
                    email,
                    username,
                    educationalBackground,
                    score: 0,
                    ip: currentIp
                };
                
                setLeaderboard(prev => [
                    ...prev,
                    { username, score: 0, ip: currentIp }
                ]);
                saveToCsv(newProfile);
                setShowProfileModal(false);
                setProfileData({ name: '', collegeName: '', email: '', username: '', educationalBackground: '' });
                setStatus('Profile created');
            };

            const handleAddProfile = () => {
                setShowProfileModal(true);
                setProfileData({ name: '', collegeName: '', email: '', username: '', educationalBackground: '' });
            };

            const handleCheckboxChange = (username) => {
                setSelectedProfiles(prev => 
                    prev.includes(username)
                        ? prev.filter(n => n !== username)
                        : [...prev, username]
                );
            };

            const handleDeleteProfile = () => {
                if (selectedProfiles.length === 0) {
                    setStatus('Please select at least one profile to delete');
                    return;
                }
                
                const invalidSelections = selectedProfiles.filter(username => {
                    const entry = leaderboard.find(entry => entry.username === username);
                    return entry && entry.ip !== currentIp;
                });

                if (invalidSelections.length > 0) {
                    setStatus('You can only delete profiles created from your IP');
                    return;
                }

                setShowDeleteConfirm(true);
            };

            const confirmDelete = () => {
                const updatedLeaderboard = leaderboard.filter(entry => !selectedProfiles.includes(entry.username));
                setLeaderboard(updatedLeaderboard);
                const csvHeader = "Name,College Name,Email ID,Username,Educational Background,Score,IP\n";
                const escapeCsvField = (field) => `"${field.replace(/"/g, '""')}"`;
                let updatedCsv = csvHeader;
                updatedLeaderboard.forEach(entry => {
                    const fullProfile = (localStorage.getItem('profileDatabase') || '').split('\n').slice(1).find(row => row.includes(entry.username));
                    if (fullProfile) {
                        updatedCsv += fullProfile + '\n';
                    }
                });
                localStorage.setItem('profileDatabase', updatedCsv);
                setSelectedProfiles([]);
                setShowDeleteConfirm(false);
                setStatus('Profile(s) deleted');
            };

            const cancelDelete = () => {
                setShowDeleteConfirm(false);
                setStatus('Deletion cancelled');
            };

            const handleControl = (command) => {
                const step = 1;
                let newAngles = [...angles];
                let newHeight = height;
                let newThrottle = throttle;
                
                switch (command) {
                    case 'Up': newThrottle = Math.min(newThrottle + 10, 100); break;
                    case 'Down': newThrottle = Math.max(newThrottle - 10, 0); break;
                    case 'Forward': newAngles[1] = Math.min(newAngles[1] + step, 45); break;
                    case 'Backward': newAngles[1] = Math.max(newAngles[1] - step, -45); break;
                    case 'Left': newAngles[0] = Math.max(newAngles[0] - step, -45); break;
                    case 'Right': newAngles[0] = Math.min(newAngles[0] + step, 45); break;
                    case 'Yaw Left': newAngles[2] = (newAngles[2] - step) % 360; break;
                    case 'Yaw Right': newAngles[2] = (newAngles[2] + step) % 360; break;
                    case 'Reset': 
                        newAngles = [0, 0, 0];
                        newHeight = 0;
                        newThrottle = 0;
                        break;
                }
                
                setAngles(newAngles);
                setHeight(newHeight);
                setThrottle(newThrottle);
            };

            const buildCode = () => {
                setStatus('Building...');
                setBuildOutput('');
                
                setTimeout(() => {
                    try {
                        if (!editorContent.includes('def mode(')) {
                            throw new Error('Missing mode() function');
                        }
                        
                        setBuildOutput('Build successful!\nCode validated and ready for simulation');
                        setStatus('Ready');
                    } catch (error) {
                        setBuildOutput(`Build failed: ${error.message}`);
                        setStatus('Build error');
                    }
                }, 1000);
            };

            const startSimulation = () => {
                if (buildOutput.includes('failed')) {
                    setStatus('Fix build errors first');
                    return;
                }
                
                setStatus('Starting simulation...');
                setIsSimulating(true);
                setSimulationError(null); // Reset error state
                setSimulationWarnings([]);
                setTestResult(null);
                setStabilityReport(null);
                
                // Apply custom inputs
                setHeight(parseFloat(customInputs.initialHeight) || 0);
                setAngles([
                    parseFloat(customInputs.initialRoll) || 0,
                    parseFloat(customInputs.initialPitch) || 0,
                    parseFloat(customInputs.initialYaw) || 0
                ]);
                setThrottle(50); // Start with neutral throttle
                
                setTimeout(() => {
                    setStatus('Simulation running');
                }, 500);
            };

            const stopSimulation = () => {
                setIsSimulating(false);
                setStatus('Simulation stopped');
            };

            const deployToDrone = async () => {
                if (isDeploying) {
                    setStatus('Deployment already in progress');
                    return;
                }
                if (!buildOutput.includes('successful')) {
                    setStatus('Code not built successfully');
                    return;
                }
                if (editorContent.length > 10000) {
                    setStatus('Code size exceeds drone memory limit');
                    return;
                }

                setIsDeploying(true);
                setDeployProgress(0);
                setStatus('Connecting to drone...');

                let ws;
                try {
                    ws = new WebSocket(`ws://${droneConfig.ip}:${droneConfig.port}`);
                    
                    ws.onopen = () => {
                        setStatus('Sending deploy command...');
                        ws.send('deploy_code\n');
                    };

                    ws.onmessage = async (event) => {
                        const message = event.data.trim();
                        console.log('Received from drone:', message);

                        if (message === 'ack: deploy_ready') {
                            setStatus('Sending code...');
                            const chunkSize = 128;
                            const code = editorContent + '\nEOF\n';
                            const totalBytes = code.length;
                            let bytesSent = 0;

                            while (bytesSent < totalBytes) {
                                const chunk = code.slice(bytesSent, bytesSent + chunkSize);
                                ws.send(chunk);
                                bytesSent += chunk.length;
                                setDeployProgress(Math.min((bytesSent / totalBytes) * 100, 100));
                                await new Promise(resolve => setTimeout(resolve, 10));
                            }
                        } else if (message === 'ack: code_received') {
                            setStatus('Deployment successful');
                            ws.send('ping\n');
                        } else if (message.startsWith('error:')) {
                            setStatus(`Deployment failed: ${message}`);
                            ws.close();
                        } else if (message === 'pong') {
                            setStatus('Deployment successful, drone responsive');
                            ws.close();
                        }
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocket Error:', error);
                        setStatus('Deployment failed: Connection error');
                        setIsDeploying(false);
                        setDeployProgress(0);
                    };

                    ws.onclose = () => {
                        setIsDeploying(false);
                        setDeployProgress(0);
                        if (status !== 'Deployment successful' && status !== 'Deployment successful, drone responsive') {
                            setStatus('Deployment failed: Connection closed');
                        }
                    };

                    setTimeout(() => {
                        if (ws.readyState !== WebSocket.OPEN && ws.readyState !== WebSocket.CLOSED) {
                            ws.close();
                            setStatus('Deployment failed: Connection timeout');
                            setIsDeploying(false);
                            setDeployProgress(0);
                        }
                    }, 5000);

                } catch (error) {
                    console.error('Deployment Error:', error);
                    setStatus(`Deployment failed: ${error.message}`);
                    setIsDeploying(false);
                    setDeployProgress(0);
                    if (ws) ws.close();
                }
            };

            const convertLogic = () => {
                if (!logicInput.trim()) {
                    setStatus('Enter logic first');
                    return;
                }
                
                setStatus('Converting logic...');
                
                try {
                    let convertedCode = '';
                    const input = logicInput.toLowerCase();
                    
                    if (input.includes('if height >')) {
                        const value = logicInput.match(/height > (\d+)/)?.[1] || '1';
                        const action = input.includes('increase') ? '+' : '-';
                        const amount = logicInput.match(/(\d+)/)?.[1] || '10';
                        convertedCode = `if height > ${value}:\n    # Adjust throttle\n    throttle = throttle ${action} ${amount}`;
                    } 
                    else if (input.includes('if height <')) {
                        const value = logicInput.match(/height < (\d+)/)?.[1] || '1';
                        const action = input.includes('increase') ? '+' : '-';
                        const amount = logicInput.match(/(\d+)/)?.[1] || '10';
                        convertedCode = `if height < ${value}:\n    # Adjust throttle\n    throttle = throttle ${action} ${amount}`;
                    }
                    else if (input.includes('if roll >')) {
                        const value = logicInput.match(/roll > (\d+)/)?.[1] || '5';
                        const correction = input.includes('left') ? '-' : '+';
                        convertedCode = `if angles[0] > ${value}:\n    # Correct roll\n    roll_corr = roll_corr ${correction} 100`;
                    }
                    else if (input.includes('if pitch >')) {
                        const value = logicInput.match(/pitch > (\d+)/)?.[1] || '5';
                        const correction = input.includes('forward') ? '-' : '+';
                        convertedCode = `if angles[1] > ${value}:\n    # Correct pitch\n    pitch_corr = pitch_corr ${correction} 100`;
                    }
                    else if (input.includes('after') && input.includes('seconds')) {
                        const seconds = logicInput.match(/(\d+)\s*seconds/)?.[1] || '5';
                        const action = input.includes('increase') ? '+' : '-';
                        const amount = input.includes('by') ? input.match(/by (\d+)/)?.[1] || '10' : '10';
                        convertedCode = `if time_elapsed > ${seconds}:\n    # Time-based adjustment\n    throttle = throttle ${action} ${amount}`;
                    }
                    else {
                        convertedCode = `# Custom logic implementation\n# Original: ${logicInput}\n# Implement your custom logic here`;
                    }
                    
                    convertedCode += `\n    # Ensure throttle stays within 0-100 range\n    throttle = max(min(throttle, 100), 0)`;
                    
                    const newContent = editorContent + '\n\n' + convertedCode;
                    setEditorContent(newContent);
                    editorRef.current.setValue(newContent);
                    
                    setStatus('Logic converted to code');
                } catch (error) {
                    setStatus('Conversion error: ' + error.message);
                }
            };

            const selectChallenge = (challenge) => {
                setActiveTab('CHALLENGES');
                setStatus(`Challenge: ${challenge.title}`);
                
                const newContent = codeTemplates['CHALLENGES'] + `\n\n# Challenge: ${challenge.title}\n# ${challenge.description}`;
                setEditorContent(newContent);
                editorRef.current.setValue(newContent);
                
                setUserProgress(prev => ({
                    ...prev,
                    [challenge.id]: { ...prev[challenge.id], attempted: true }
                }));
                
                setIsSimulating(true);
            };

            const checkChallenge = (challenge) => {
                const criteria = challenge.criteria;
                setStatus('Evaluating...');
                
                setTimeout(() => {
                    const heightOk = Math.abs(height - criteria.height) <= 0.5;
                    const rollOk = Math.abs(angles[0]) <= criteria.rollMax;
                    const pitchOk = Math.abs(angles[1]) <= criteria.pitchMax;
                    
                    if (heightOk && rollOk && pitchOk) {
                        setStatus('Challenge completed!');
                        
                        setUserProgress(prev => ({
                            ...prev,
                            [challenge.id]: { completed: true, score: challenge.points }
                        }));
                        
                        setLeaderboard(prev => {
                            const newLeaderboard = prev.map(entry => 
                                entry.username === profileData.username 
                                    ? { ...entry, score: entry.score + challenge.points }
                                    : entry
                            ).sort((a, b) => b.score - a.score);
                            
                            // Update CSV with new scores
                            const csvHeader = "Name,College Name,Email ID,Username,Educational Background,Score,IP\n";
                            const escapeCsvField = (field) => `"${field.replace(/"/g, '""')}"`;
                            let updatedCsv = csvHeader;
                            newLeaderboard.forEach(entry => {
                                const fullProfile = (localStorage.getItem('profileDatabase') || '').split('\n').slice(1).find(row => row.includes(entry.username));
                                if (fullProfile) {
                                    const profileParts = fullProfile.split(',').map(part => part.replace(/^"|"$/g, '').replace(/""/g, '"'));
                                    profileParts[5] = entry.score; // Update score
                                    updatedCsv += profileParts.map(part => escapeCsvField(part)).join(',') + '\n';
                                }
                            });
                            localStorage.setItem('profileDatabase', updatedCsv);
                            
                            return [...newLeaderboard];
                        });
                    } else {
                        setStatus('Challenge not completed');
                    }
                }, 1500);
            };

            return (
                <div className="interface-font p-4 max-w-[100vw]">
                    {showProfileModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
                            <div className="cyber-card p-6 w-96">
                                <h3 className="text-lg mb-4" style={{ color: '#00f0ff' }}>
                                    CREATE PROFILE
                                </h3>
                                <div className="space-y-2">
                                    <div>
                                        <label className="text-xs text-gray-400">Name</label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            placeholder="Enter full name"
                                            value={profileData.name}
                                            onChange={(e) => setProfileData({ ...profileData, name: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400">College Name</label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            placeholder="Enter college name"
                                            value={profileData.collegeName}
                                            onChange={(e) => setProfileData({ ...profileData, collegeName: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400">Email ID</label>
                                        <input
                                            type="email"
                                            className="input-field"
                                            placeholder="Enter email ID"
                                            value={profileData.email}
                                            onChange={(e) => setProfileData({ ...profileData, email: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400">Username</label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            placeholder="Enter username (max 15 chars)"
                                            value={profileData.username}
                                            onChange={(e) => setProfileData({ ...profileData, username: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400">Educational Background</label>
                                        <input
                                            type="text"
                                            className="input-field"
                                            placeholder="e.g., B.Tech in CSE, 2nd Year"
                                            value={profileData.educationalBackground}
                                            onChange={(e) => setProfileData({ ...profileData, educationalBackground: e.target.value })}
                                        />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 mt-4">
                                    <button
                                        onClick={handleCreateProfile}
                                        className="cyber-button"
                                    >
                                        CREATE
                                    </button>
                                    <button
                                        onClick={() => setShowProfileModal(false)}
                                        className="delete-button"
                                    >
                                        CANCEL
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
                            <div className="cyber-card p-6 w-96">
                                <h3 className="text-lg mb-4" style={{ color: '#00f0ff' }}>
                                    CONFIRM DELETION
                                </h3>
                                <p className="mb-4 text-sm">
                                    Are you sure you want to delete the selected profile(s)?
                                </p>
                                <div className="grid grid-cols-2 gap-2">
                                    <button
                                        onClick={confirmDelete}
                                        className="cyber-button"
                                    >
                                        YES
                                    </button>
                                    <button
                                        onClick={cancelDelete}
                                        className="delete-button"
                                    >
                                        NO
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-4">
                        <div>
                            <h1 className="text-2xl" style={{ color: '#00f0ff' }}>
                                AirM FATEH DRONE
                            </h1>
                            <h2 className="text-lg" style={{ color: '#ff3e7f' }}>
                                LOGIC PROGRAMMING INTERFACE
                            </h2>
                        </div>
                        <div className="flex items-center">
                            <div className={`w-3 h-3 rounded-full mr-2 ${status.includes('error') || status.includes('failed') ? 'bg-red-500' : 'bg-green-500'}`}></div>
                            <span className="text-sm">{status}</span>
                        </div>
                    </div>
                    
                    <div className="cyber-card p-4 mb-4">
                        <h3 className="text-lg mb-2" style={{ color: '#00f0ff' }}>
                            DRONE CONNECTION
                        </h3>
                        <div className="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label className="text-xs text-gray-400">IP Address</label>
                                <input
                                    type="text"
                                    className="input-field"
                                    value={droneConfig.ip}
                                    onChange={(e) => saveDroneConfig({ ...droneConfig, ip: e.target.value })}
                                    placeholder="192.168.4.1"
                                />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">Port</label>
                                <input
                                    type="number"
                                    className="input-field"
                                    value={droneConfig.port}
                                    onChange={(e) => saveDroneConfig({ ...droneConfig, port: e.target.value })}
                                    placeholder="8080"
                                />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">Wi-Fi SSID</label>
                                <input
                                    type="text"
                                    className="input-field"
                                    value={droneConfig.ssid}
                                    onChange={(e) => saveDroneConfig({ ...droneConfig, ssid: e.target.value })}
                                    placeholder="PicoW"
                                />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">Wi-Fi Password</label>
                                <input
                                    type="password"
                                    className="input-field"
                                    value={droneConfig.password}
                                    onChange={(e) => saveDroneConfig({ ...droneConfig, password: e.target.value })}
                                    placeholder="pico1234"
                                />
                            </div>
                        </div>
                        <div className="flex justify-between items-center">
                            <button
                                onClick={testDroneConnection}
                                className="cyber-button"
                            >
                                TEST CONNECTION
                            </button>
                            <span className="text-sm" style={{ color: connectionStatus === 'Connected' ? '#00ff80' : '#ff3e7f' }}>
                                {connectionStatus}
                            </span>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 scrollable-container">
                        <div className="cyber-card p-4 dynamic-height flex flex-col">
                            <h3 className="text-lg mb-2" style={{ color: '#00f0ff' }}>
                                CODE EDITOR
                            </h3>
                            <div 
                                id="editor" 
                                className="editor-font flex-grow w-full border border-gray-700 rounded"
                                style={{ backgroundColor: '#0a0a1a' }}
                            ></div>
                            
                            <div className="mt-4">
                                <textarea
                                    className="w-full h-16 p-2 bg-black text-cyan-300 border border-purple-500 rounded-md text-xs font-mono mb-2"
                                    placeholder="Enter logic (e.g., 'If height > 10, reduce throttle by 10%')"
                                    value={logicInput}
                                    onChange={(e) => setLogicInput(e.target.value)}
                                />
                            </div>
                            
                            <div className="grid grid-cols-2 gap-2">
                                <button 
                                    onClick={buildCode}
                                    className="cyber-button"
                                    disabled={isDeploying}
                                >
                                    BUILD
                                </button>
                                <button 
                                    onClick={startSimulation}
                                    className="cyber-button"
                                    disabled={!buildOutput.includes('successful') || isDeploying}
                                >
                                    SIMULATE
                                </button>
                                <button 
                                    onClick={deployToDrone}
                                    className="cyber-button"
                                    disabled={isDeploying}
                                >
                                    {isDeploying ? 'DEPLOYING...' : 'DEPLOY'}
                                </button>
                                <button 
                                    onClick={convertLogic}
                                    className="cyber-button"
                                    disabled={isDeploying}
                                >
                                    CONVERT
                                </button>
                            </div>
                            
                            {isDeploying && (
                                <div className="mt-2">
                                    <div className="progress-bar">
                                        <div 
                                            className="progress-fill" 
                                            style={{ width: `${deployProgress}%` }}
                                        ></div>
                                        <span className="progress-text">
                                            {Math.round(deployProgress)}%
                                        </span>
                                    </div>
                                </div>
                            )}
                            
                            {buildOutput && (
                                <div className="mt-2 p-2 bg-black rounded text-xs font-mono text-green-400 overflow-auto max-h-20">
                                    {buildOutput}
                                </div>
                            )}
                        </div>
                        
                        <div className="cyber-card p-4 dynamic-height flex flex-col">
                            <h3 className="text-lg mb-2" style={{ color: '#00f0ff' }}>
                                {simulationError ? 'SIMULATION ERROR' : 'DRONE SIMULATION'}
                            </h3>
                            
                            {simulationError ? (
                                <div className="error-message flex-grow">
                                    {simulationError}
                                </div>
                            ) : (
                                <>
                                    <div 
                                        ref={containerRef} 
                                        className="hologram-container mb-4"
                                        id="simulation-container"
                                    ></div>
                                    
                                    <div className="mb-4">
                                        <details>
                                            <summary>Test Scenarios</summary>
                                            <select
                                                className="input-field mt-2"
                                                value={selectedTestScenario}
                                                onChange={(e) => setSelectedTestScenario(e.target.value)}
                                            >
                                                <option value="">Select a scenario</option>
                                                {testScenarios.map(scenario => (
                                                    <option key={scenario.id} value={scenario.id}>
                                                        {scenario.name}
                                                    </option>
                                                ))}
                                            </select>
                                        </details>
                                    </div>

                                    <div className="mb-4">
                                        <details>
                                            <summary>Telemetry</summary>
                                            <table className="telemetry-table mt-2">
                                                <thead>
                                                    <tr>
                                                        <th>Parameter</th>
                                                        <th>Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>Height</td>
                                                        <td>{height.toFixed(1)}m</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Roll</td>
                                                        <td>{angles[0].toFixed(1)}°</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Pitch</td>
                                                        <td>{angles[1].toFixed(1)}°</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Yaw</td>
                                                        <td>{angles[2].toFixed(1)}°</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Throttle</td>
                                                        <td>{throttle.toFixed(0)}%</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Motor 1</td>
                                                        <td>{(motorSpeeds[0] / 65535 * 100).toFixed(0)}%</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Motor 2</td>
                                                        <td>{(motorSpeeds[1] / 65535 * 100).toFixed(0)}%</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Motor 3</td>
                                                        <td>{(motorSpeeds[2] / 65535 * 100).toFixed(0)}%</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Motor 4</td>
                                                        <td>{(motorSpeeds[3] / 65535 * 100).toFixed(0)}%</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </details>
                                    </div>

                                    <div className="mb-4">
                                        <details>
                                            <summary>Controls</summary>
                                            <div className="grid grid-cols-3 gap-2 mt-2">
                                                <button 
                                                    onClick={() => handleControl('Up')}
                                                    className="cyber-button"
                                                    disabled={isDeploying}
                                                >
                                                    ↑ UP
                                                </button>
                                                <button 
                                                    onClick={() => handleControl('Forward')}
                                                    className="cyber-button"
                                                    disabled={isDeploying}
                                                >
                                                    ↗ FWD
                                                </button>
                                                <button 
                                                    onClick={stopSimulation}
                                                    className="cyber-button"
                                                    disabled={!isSimulating || isDeploying}
                                                >
                                                    ■ STOP
                                                </button>
                                                <button 
                                                    onClick={() => handleControl('Left')}
                                                    className="cyber-button"
                                                    disabled={isDeploying}
                                                >
                                                    ← LEFT
                                                </button>
                                                <button 
                                                    onClick={() => handleControl('Down')}
                                                    className="cyber-button"
                                                    disabled={isDeploying}
                                                >
                                                    ↓ DOWN
                                                </button>
                                                <button 
                                                    onClick={() => handleControl('Right')}
                                                    className="cyber-button"
                                                    disabled={isDeploying}
                                                >
                                                    → RIGHT
                                                </button>
                                            </div>
                                        </details>
                                    </div>

                                    <div className="mb-4">
                                        <h4 className="text-sm mb-2" style={{ color: '#ff3e7f' }}>
                                            Custom Initial Conditions
                                        </h4>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <label className="text-xs text-gray-400">Initial Height (m)</label>
                                                <input
                                                    type="number"
                                                    className="input-field"
                                                    value={customInputs.initialHeight}
                                                    onChange={(e) => setCustomInputs({ ...customInputs, initialHeight: e.target.value })}
                                                    placeholder="0"
                                                    min="0"
                                                    max="10"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-xs text-gray-400">Initial Roll (°)</label>
                                                <input
                                                    type="number"
                                                    className="input-field"
                                                    value={customInputs.initialRoll}
                                                    onChange={(e) => setCustomInputs({ ...customInputs, initialRoll: e.target.value })}
                                                    placeholder="0"
                                                    min="-45"
                                                    max="45"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-xs text-gray-400">Initial Pitch (°)</label>
                                                <input
                                                    type="number"
                                                    className="input-field"
                                                    value={customInputs.initialPitch}
                                                    onChange={(e) => setCustomInputs({ ...customInputs, initialPitch: e.target.value })}
                                                    placeholder="0"
                                                    min="-45"
                                                    max="45"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-xs text-gray-400">Initial Yaw (°)</label>
                                                <input
                                                    type="number"
                                                    className="input-field"
                                                    value={customInputs.initialYaw}
                                                    onChange={(e) => setCustomInputs({ ...customInputs, initialYaw: e.target.value })}
                                                    placeholder="0"
                                                    min="-360"
                                                    max="360"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {simulationWarnings.length > 0 && (
                                        <div className="warning-message">
                                            <h4 className="text-sm mb-2">Warnings</h4>
                                            <ul>
                                                {simulationWarnings.map((warning, index) => (
                                                    <li key={index}>{warning}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}

                                    {testResult && (
                                        <div className="report-card">
                                            <h4 className="text-sm mb-2">Test Result: {testResult.scenario}</h4>
                                            <p>Status: <span style={{ color: testResult.passed ? '#00ff80' : '#ff3e7f' }}>
                                                {testResult.passed ? 'Passed' : 'Failed'}
                                            </span></p>
                                            <ul>
                                                <li>Height: {testResult.details.height}</li>
                                                <li>Roll: {testResult.details.roll}</li>
                                                <li>Pitch: {testResult.details.pitch}</li>
                                                <li>Yaw: {testResult.details.yaw}</li>
                                            </ul>
                                        </div>
                                    )}

                                    {stabilityReport && (
                                        <div className="report-card">
                                            <h4 className="text-sm mb-2">Stability Report</h4>
                                            <p>Stability Score: {stabilityReport.stabilityScore}%</p>
                                            <p>Response Time: {stabilityReport.responseTime}s</p>
                                        </div>
                                    )}

                                    <div className="grid grid-cols-3 gap-2 mb-4">
                                        <div>
                                            <p className="text-xs text-gray-400">MODE</p>
                                            <p style={{ color: '#00f0ff' }}>{activeTab}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-gray-400">STATUS</p>
                                            <p style={{ color: isSimulating ? '#00ff80' : '#ff3e7f' }}>
                                                {isSimulating ? 'ACTIVE' : 'STANDBY'}
                                            </p>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                        
                        <div className="cyber-card p-4 dynamic-height flex flex-col">
                            <h3 className="text-lg mb-2" style={{ color: '#00f0ff' }}>
                                CONTROL MODULES
                            </h3>
                            
                            <div className="grid grid-cols-3 gap-2 mb-4">
                                <button 
                                    className={`cyber-button ${activeTab === 'FATEH-V1' ? 'tab-active' : ''}`}
                                    onClick={() => setActiveTab('FATEH-V1')}
                                    disabled={isDeploying}
                                >
                                    FATEH-V1
                                </button>
                                <button 
                                    className={`cyber-button ${activeTab === 'CUSTOM' ? 'tab-active' : ''}`}
                                    onClick={() => setActiveTab('CUSTOM')}
                                    disabled={isDeploying}
                                >
                                    CUSTOM
                                </button>
                                <button 
                                    className={`cyber-button ${activeTab === 'CHALLENGES' ? 'tab-active' : ''}`}
                                    onClick={() => setActiveTab('CHALLENGES')}
                                    disabled={isDeploying}
                                >
                                    CHALLENGES
                                </button>
                            </div>
                            
                            {activeTab === 'CHALLENGES' && (
                                <div className="mb-4 flex-grow overflow-y-auto">
                                    <h4 className="text-md mb-2" style={{ color: '#ff3e7f' }}>
                                        CHALLENGES
                                    </h4>
                                    <div className="space-y-2">
                                        {challenges.map(challenge => (
                                            <div key={challenge.id} className="cyber-card p-2">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h5 className="font-bold">{challenge.title}</h5>
                                                        <p className="text-xs text-gray-300">{challenge.description}</p>
                                                        <p className="text-xs" style={{ color: '#00f0ff' }}>
                                                            Reward: {challenge.points} CR
                                                        </p>
                                                    </div>
                                                    {userProgress[challenge.id]?.completed ? (
                                                        <span className="completed-badge">COMPLETED</span>
                                                    ) : (
                                                        <div className="flex gap-1">
                                                            <button 
                                                                className="cyber-button text-xs"
                                                                onClick={() => selectChallenge(challenge)}
                                                                disabled={isDeploying}
                                                            >
                                                                START
                                                            </button>
                                                            {userProgress[challenge.id]?.attempted && (
                                                                <button 
                                                                    className="cyber-button text-xs"
                                                                    onClick={() => checkChallenge(challenge)}
                                                                    disabled={isDeploying}
                                                                >
                                                                    CHECK
                                                                </button>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            <h4 className="text-md mb-2" style={{ color: '#ff3e7f' }}>
                                LEADERBOARD
                            </h4>
                            <div className="space-y-2 flex-grow">
                                {leaderboard.sort((a, b) => b.score - a.score).slice(0, 5).map((entry, index) => (
                                    <div key={entry.username} className="flex justify-between items-center">
                                        <label className="flex items-center">
                                            <input
                                                type="checkbox"
                                                checked={selectedProfiles.includes(entry.username)}
                                                onChange={() => handleCheckboxChange(entry.username)}
                                                disabled={entry.ip !== currentIp || isDeploying}
                                                className="mr-2"
                                            />
                                            <span>{index + 1}. {entry.username}</span>
                                        </label>
                                        <span style={{ color: '#00f0ff' }}>{entry.score} CR</span>
                                    </div>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-2 mt-4">
                                <button
                                    onClick={handleAddProfile}
                                    className="add-button"
                                    disabled={isDeploying}
                                >
                                    ADD PROFILE
                                </button>
                                <button
                                    onClick={handleDeleteProfile}
                                    className="delete-button"
                                    disabled={isDeploying}
                                >
                                    DELETE
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="cyber-card p-2 mt-4 text-center text-xs">
                        CONNECT TO DRONE WIFI BEFORE DEPLOYING | VERSION: FATEH 1.0
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
